<!-- -*- mode: jinja2 -*- -->

{% extends "base.html" %}
{% block title %}{{ iofile.io_filename }} &ndash; {{ project }} {% endblock title %}
{% block body %}
  {% import 'macros.html' as macros %}
  <div class="row">
    <h1>{{ iofile.io_filename }}
      <small>I/O File</small>
    </h1>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <dl class="dl-horizontal">
            <dt>Unit Number</dt>
            <dd><code>{{ iofile.unit }}</code></dd>
            <dt>I/O Type</dt>
            <dd>
              {% if iofile.io_type == 'Input/Output' %}
                <span class="badge bg-info">Input/Output</span>
              {% elif iofile.io_type == 'Input' %}
                <span class="badge bg-success">Input</span>
              {% elif iofile.io_type == 'Output' %}
                <span class="badge bg-primary">Output</span>
              {% else %}
                <span class="badge bg-secondary">Unknown</span>
              {% endif %}
            </dd>
            <dt>Total Operations</dt>
            <dd>{{ iofile.operations|length }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      {{ macros.sidebar(project, iofile) }}
    </div>
    
    <div class="col-md-9" id='text'>
      <h2>Procedures Using This File</h2>
      {% if iofile.procedures %}
        {# Create collapsible sections for each procedure #}
        {% for proc_info in iofile.procedures %}
          {% set proc = proc_info.procedure %}
          {% set ops = proc_info.operations %}
          {% set proc_id = 'proc-' ~ loop.index %}
          
          <div class="card mb-3">
            <a data-bs-toggle="collapse" href="#{{ proc_id }}" 
               aria-expanded="false" 
               aria-controls="{{ proc_id }}" 
               class="text-decoration-none">
              <h3 class="card-header bg-light text-dark">
                <i class="fa fa-caret-down me-2"></i>{{ proc.name }}
                <small class="text-muted">
                  (from {{ proc.parent.name if proc.parent else 'unknown' }})
                </small>
              </h3>
            </a>
            <div id="{{ proc_id }}" class="collapse">
              <div class="card-body">
                {# Subsection 1: I/O Operations #}
                <h4>I/O Operations</h4>
                {% if ops.timeline %}
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        <th>Line</th>
                        <th>Operation</th>
                        <th>Raw Statement</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for op in ops.timeline %}
                        <tr>
                          <td>{% if op.line %}{{ op.line }}{% else %}-{% endif %}</td>
                          <td>
                            {% if op.kind == 'read' %}
                              <span class="badge bg-success">Read</span>
                            {% elif op.kind == 'write' %}
                              <span class="badge bg-primary">Write</span>
                            {% elif op.kind == 'open' %}
                              <span class="badge bg-info">Open</span>
                            {% elif op.kind == 'close' %}
                              <span class="badge bg-secondary">Close</span>
                            {% else %}
                              <span class="badge bg-secondary">{{ op.kind }}</span>
                            {% endif %}
                          </td>
                          <td><code>{{ op.raw }}</code></td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <p><em>No operations recorded for this procedure.</em></p>
                {% endif %}
                
                {# Subsection 2a: Variables Written to This File (for Output and Input/Output files) - ONLY for procedures that write #}
                {% if iofile.io_type in ['Output', 'Input/Output'] %}
                  {% set has_write_ops = namespace(value=false) %}
                  {% if ops.timeline %}
                    {% for op in ops.timeline %}
                      {% if op.kind == 'write' %}
                        {% set has_write_ops.value = true %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {% if has_write_ops.value %}
                    <h4>Variables Written to This File</h4>
                    {% set proc_write_vars = [] %}
                    {% set seen_write_vars = [] %}
                    
                    {# Collect write variables for this procedure #}
                    {% if ops.timeline %}
                      {% for op in ops.timeline %}
                        {% if op.kind == 'write' and op.parameters %}
                          {% for param in op.parameters %}
                            {# Parse the parameter to extract its components #}
                            {% set param_info = {} %}
                            {% set _ = param_info.update({'full_name': param, 'procedure': proc, 'line': op.line}) %}
                            
                            {# Extract base variable name #}
                            {% set base_name = none %}
                            {% set component_name = none %}
                            {% if '%' in param %}
                              {% set parts = param.split('%') %}
                              {% set base_name = parts[0].split('(')[0] %}
                              {% set component_name = parts[-1].split('(')[0] %}
                            {% else %}
                              {% set base_name = param.split('(')[0] %}
                              {% set component_name = none %}
                            {% endif %}
                            {% set _ = param_info.update({'base_name': base_name, 'component_name': component_name}) %}
                            
                            {# Add to list only if not already seen (remove duplicates) #}
                            {% set var_key = base_name ~ '_' ~ (component_name if component_name else '') %}
                            {% if var_key not in seen_write_vars %}
                              {% set _ = seen_write_vars.append(var_key) %}
                              {% set _ = proc_write_vars.append(param_info) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    
                    {% if proc_write_vars %}
                      <table class="table table-sm table-striped">
                        <thead>
                          <tr>
                            <th>Module</th>
                            <th>Derived Type</th>
                            <th>Variable Name</th>
                            <th>Data Type</th>
                            <th>Component Name</th>
                            <th>Default Value / Initial</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for var_info in proc_write_vars %}
                            <tr>
                              {# Column 1: Module #}
                              <td>
                                {% set found_var = namespace(value=none) %}
                                {% set is_local = namespace(value=false) %}
                                
                                {% if var_info.procedure.variables is defined %}
                                  {% for v in var_info.procedure.variables %}
                                    {% if v.name.lower() == var_info.base_name.lower() %}
                                      {% set found_var.value = v %}
                                      {% set is_local.value = true %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                                
                                {% if not found_var.value and var_info.procedure.all_vars is defined %}
                                  {% if var_info.base_name.lower() in var_info.procedure.all_vars %}
                                    {% set found_var.value = var_info.procedure.all_vars[var_info.base_name.lower()] %}
                                  {% endif %}
                                {% endif %}
                                
                                {% if is_local.value %}
                                  Local
                                {% elif found_var.value and found_var.value.parent %}
                                  {% if found_var.value.parent.obj == 'module' %}
                                    {{ found_var.value.parent | relurl(page_url) }}
                                  {% else %}
                                    Local
                                  {% endif %}
                                {% else %}
                                  <em>unknown</em>
                                {% endif %}
                              </td>
                              
                              {# Column 2: Derived Type #}
                              <td>
                                {% if found_var.value and found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is string %}
                                    <code>{{ type_obj }}</code>
                                  {% else %}
                                    {{ type_obj | relurl(page_url) }}
                                  {% endif %}
                                {% else %}
                                  NA
                                {% endif %}
                              </td>
                              
                              {# Column 3: Variable Name #}
                              <td>
                                <code>{{ var_info.base_name }}</code>
                              </td>
                              
                              {# Column 4: Data Type #}
                              <td>
                                {% if var_info.component_name and found_var.value %}
                                  {% set component_var = namespace(value=none) %}
                                  {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                    {% set type_obj = found_var.value.proto[0] %}
                                    {% if type_obj is not string and type_obj.variables is defined %}
                                      {% for comp in type_obj.variables %}
                                        {% if comp.name.lower() == var_info.component_name.lower() %}
                                          {% set component_var.value = comp %}
                                        {% endif %}
                                      {% endfor %}
                                    {% endif %}
                                  {% endif %}
                                  {% if component_var.value %}
                                    <code>{{ component_var.value.full_type }}</code>
                                  {% else %}
                                    <em>unknown</em>
                                  {% endif %}
                                {% elif found_var.value %}
                                  <code>{{ found_var.value.full_type }}</code>
                                {% else %}
                                  <em>unknown</em>
                                {% endif %}
                              </td>
                              
                              {# Column 5: Component Name #}
                              <td>
                                {% if var_info.component_name %}
                                  <code>{{ var_info.component_name }}</code>
                                {% else %}
                                  <em>-</em>
                                {% endif %}
                              </td>
                              
                              {# Column 6: Default Value / Initial #}
                              <td>
                                {% if var_info.component_name and found_var.value %}
                                  {% set component_var = namespace(value=none) %}
                                  {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                    {% set type_obj = found_var.value.proto[0] %}
                                    {% if type_obj is not string and type_obj.variables is defined %}
                                      {% for comp in type_obj.variables %}
                                        {% if comp.name.lower() == var_info.component_name.lower() %}
                                          {% set component_var.value = comp %}
                                        {% endif %}
                                      {% endfor %}
                                    {% endif %}
                                  {% endif %}
                                  {% if component_var.value and component_var.value.initial %}
                                    <code>{{ component_var.value.initial }}</code>
                                  {% else %}
                                    <em>-</em>
                                  {% endif %}
                                {% elif found_var.value and found_var.value.initial %}
                                  <code>{{ found_var.value.initial }}</code>
                                {% else %}
                                  <em>-</em>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <p><em>No write variables information available.</em></p>
                    {% endif %}
                  {% endif %}
                {% endif %}
                
                {# Subsection 2b: Variables Read from This File (for Input and Input/Output files) #}
                {% if iofile.io_type in ['Input', 'Input/Output'] %}
                  <h4>Variables Read from This File</h4>
                  {% set proc_read_vars = [] %}
                  {% set seen_vars = [] %}
                  
                  {# Collect read variables for this procedure #}
                  {% if ops.timeline %}
                    {% for op in ops.timeline %}
                      {% if op.kind == 'read' and op.parameters %}
                        {% for param in op.parameters %}
                          {# Parse the parameter to extract its components #}
                          {% set param_info = {} %}
                          {% set _ = param_info.update({'full_name': param, 'procedure': proc, 'line': op.line}) %}
                          
                          {# Extract base variable name #}
                          {% set base_name = none %}
                          {% set component_name = none %}
                          {% if '%' in param %}
                            {% set parts = param.split('%') %}
                            {% set base_name = parts[0].split('(')[0] %}
                            {% set component_name = parts[-1].split('(')[0] %}
                          {% else %}
                            {% set base_name = param.split('(')[0] %}
                            {% set component_name = none %}
                          {% endif %}
                          {% set _ = param_info.update({'base_name': base_name, 'component_name': component_name}) %}
                          
                          {# Add to list only if not already seen (remove duplicates) #}
                          {% set var_key = base_name ~ '_' ~ (component_name if component_name else '') %}
                          {% if var_key not in seen_vars %}
                            {% set _ = seen_vars.append(var_key) %}
                            {% set _ = proc_read_vars.append(param_info) %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {% if proc_read_vars %}
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Module</th>
                          <th>Derived Type</th>
                          <th>Variable Name</th>
                          <th>Data Type</th>
                          <th>Component Name</th>
                          <th>Default Value / Initial</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for var_info in proc_read_vars %}
                          <tr>
                            {# Column 1: Module #}
                            <td>
                              {% set found_var = namespace(value=none) %}
                              {% set is_local = namespace(value=false) %}
                              
                              {% if var_info.procedure.variables is defined %}
                                {% for v in var_info.procedure.variables %}
                                  {% if v.name.lower() == var_info.base_name.lower() %}
                                    {% set found_var.value = v %}
                                    {% set is_local.value = true %}
                                  {% endif %}
                                {% endfor %}
                              {% endif %}
                              
                              {% if not found_var.value and var_info.procedure.all_vars is defined %}
                                {% if var_info.base_name.lower() in var_info.procedure.all_vars %}
                                  {% set found_var.value = var_info.procedure.all_vars[var_info.base_name.lower()] %}
                                {% endif %}
                              {% endif %}
                              
                              {% if is_local.value %}
                                Local
                              {% elif found_var.value and found_var.value.parent %}
                                {% if found_var.value.parent.obj == 'module' %}
                                  {{ found_var.value.parent | relurl(page_url) }}
                                {% else %}
                                  Local
                                {% endif %}
                              {% else %}
                                <em>unknown</em>
                              {% endif %}
                            </td>
                            
                            {# Column 2: Derived Type #}
                            <td>
                              {% if found_var.value and found_var.value.proto and found_var.value.proto|length > 0 %}
                                {% set type_obj = found_var.value.proto[0] %}
                                {% if type_obj is string %}
                                  <code>{{ type_obj }}</code>
                                {% else %}
                                  {{ type_obj | relurl(page_url) }}
                                {% endif %}
                              {% else %}
                                NA
                              {% endif %}
                            </td>
                            
                            {# Column 3: Variable Name #}
                            <td>
                              <code>{{ var_info.base_name }}</code>
                            </td>
                            
                            {# Column 4: Data Type #}
                            <td>
                              {% if var_info.component_name and found_var.value %}
                                {% set component_var = namespace(value=none) %}
                                {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is not string and type_obj.variables is defined %}
                                    {% for comp in type_obj.variables %}
                                      {% if comp.name.lower() == var_info.component_name.lower() %}
                                        {% set component_var.value = comp %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% if component_var.value %}
                                  <code>{{ component_var.value.full_type }}</code>
                                {% else %}
                                  <em>unknown</em>
                                {% endif %}
                              {% elif found_var.value %}
                                <code>{{ found_var.value.full_type }}</code>
                              {% else %}
                                <em>unknown</em>
                              {% endif %}
                            </td>
                            
                            {# Column 5: Component Name #}
                            <td>
                              {% if var_info.component_name %}
                                <code>{{ var_info.component_name }}</code>
                              {% else %}
                                <em>-</em>
                              {% endif %}
                            </td>
                            
                            {# Column 6: Default Value / Initial #}
                            <td>
                              {% if var_info.component_name and found_var.value %}
                                {% set component_var = namespace(value=none) %}
                                {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is not string and type_obj.variables is defined %}
                                    {% for comp in type_obj.variables %}
                                      {% if comp.name.lower() == var_info.component_name.lower() %}
                                        {% set component_var.value = comp %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% if component_var.value and component_var.value.initial %}
                                  <code>{{ component_var.value.initial }}</code>
                                {% else %}
                                  <em>-</em>
                                {% endif %}
                              {% elif found_var.value and found_var.value.initial %}
                                <code>{{ found_var.value.initial }}</code>
                              {% else %}
                                <em>-</em>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p><em>No read variables information available.</em></p>
                  {% endif %}
                  
                  {# Subsection 3: FILE SCHEMA (for inputs only - per procedure) #}
                  <h4>File Schema</h4>
                  {% if proc_read_vars %}
                    <p class="text-muted">This section shows the line-by-line schema of the input file, listing each variable/component being read.</p>
                    <table class="table table-sm table-striped table-bordered">
                      <thead>
                        <tr>
                          <th>Line</th>
                          <th>Type/Component/Variable</th>
                          <th>Data Type</th>
                          <th>Initial/Default Value</th>
                          <th>Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for var_info in proc_read_vars %}
                          <tr>
                            {# Column 1: Line - Get the line from operations #}
                            <td>
                              {% if var_info.line %}{{ var_info.line }}{% else %}-{% endif %}
                            </td>
                            
                            {# Column 2: Type/Component/Variable #}
                            <td>
                              {% set found_var = namespace(value=none) %}
                              {% if var_info.procedure.variables is defined %}
                                {% for v in var_info.procedure.variables %}
                                  {% if v.name.lower() == var_info.base_name.lower() %}
                                    {% set found_var.value = v %}
                                  {% endif %}
                                {% endfor %}
                              {% endif %}
                              {% if not found_var.value and var_info.procedure.all_vars is defined %}
                                {% if var_info.base_name.lower() in var_info.procedure.all_vars %}
                                  {% set found_var.value = var_info.procedure.all_vars[var_info.base_name.lower()] %}
                                {% endif %}
                              {% endif %}
                              
                              {% if var_info.component_name %}
                                <code>{{ var_info.base_name }}%{{ var_info.component_name }}</code>
                              {% else %}
                                <code>{{ var_info.base_name }}</code>
                              {% endif %}
                              
                              {# If variable is a derived type, show the type name #}
                              {% if found_var.value and found_var.value.proto and found_var.value.proto|length > 0 %}
                                {% set type_obj = found_var.value.proto[0] %}
                                {% if type_obj is not string %}
                                  <br><small class="text-muted">({{ type_obj | relurl(page_url) }})</small>
                                {% endif %}
                              {% endif %}
                            </td>
                            
                            {# Column 3: Data Type #}
                            <td>
                              {% if var_info.component_name and found_var.value %}
                                {% set component_var = namespace(value=none) %}
                                {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is not string and type_obj.variables is defined %}
                                    {% for comp in type_obj.variables %}
                                      {% if comp.name.lower() == var_info.component_name.lower() %}
                                        {% set component_var.value = comp %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% if component_var.value %}
                                  <code>{{ component_var.value.full_type }}</code>
                                {% else %}
                                  <em>unknown</em>
                                {% endif %}
                              {% elif found_var.value %}
                                <code>{{ found_var.value.full_type }}</code>
                              {% else %}
                                <em>unknown</em>
                              {% endif %}
                            </td>
                            
                            {# Column 4: Initial/Default Value #}
                            <td>
                              {% if var_info.component_name and found_var.value %}
                                {% set component_var = namespace(value=none) %}
                                {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is not string and type_obj.variables is defined %}
                                    {% for comp in type_obj.variables %}
                                      {% if comp.name.lower() == var_info.component_name.lower() %}
                                        {% set component_var.value = comp %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% if component_var.value and component_var.value.initial %}
                                  <code>{{ component_var.value.initial }}</code>
                                {% else %}
                                  <em>-</em>
                                {% endif %}
                              {% elif found_var.value and found_var.value.initial %}
                                <code>{{ found_var.value.initial }}</code>
                              {% else %}
                                <em>-</em>
                              {% endif %}
                            </td>
                            
                            {# Column 5: Description - from variable or component doc #}
                            <td>
                              {% if var_info.component_name and found_var.value %}
                                {% set component_var = namespace(value=none) %}
                                {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                                  {% set type_obj = found_var.value.proto[0] %}
                                  {% if type_obj is not string and type_obj.variables is defined %}
                                    {% for comp in type_obj.variables %}
                                      {% if comp.name.lower() == var_info.component_name.lower() %}
                                        {% set component_var.value = comp %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                {% endif %}
                                {% if component_var.value and component_var.value.doc %}
                                  {{ component_var.value.doc|safe }}
                                {% else %}
                                  <em>-</em>
                                {% endif %}
                              {% elif found_var.value and found_var.value.doc %}
                                {{ found_var.value.doc|safe }}
                              {% else %}
                                <em>-</em>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p><em>No file schema information available.</em></p>
                  {% endif %}
                  
                  {# Subsection 4: Sample Read Format (for inputs only - per procedure) #}
                  <h4>Sample Read Format</h4>
                  {% if proc_read_vars %}
                    {# Categorize variables #}
                    {% set read_header_vars = [] %}
                    {% set read_units_vars = [] %}
                    {% set read_data_vars = [] %}
                    {% set read_seen_base_vars = [] %}
                    
                    {% for var_info in proc_read_vars %}
                      {% set var_name = var_info.base_name %}
                      {% if var_name not in read_seen_base_vars %}
                        {% set _ = read_seen_base_vars.append(var_name) %}
                        {% if '_hdr_units' in var_name.lower() or '_units' in var_name.lower() %}
                          {% set _ = read_units_vars.append(var_info) %}
                        {% elif '_hdr' in var_name.lower() %}
                          {% set _ = read_header_vars.append(var_info) %}
                        {% else %}
                          {% set _ = read_data_vars.append(var_info) %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                    
                    {% if read_header_vars or read_units_vars or read_data_vars %}
                      <p class="text-muted">The following shows an example of how this file is formatted for reading in this procedure:</p>
                      <div class="card">
                        <div class="card-body">
                          <pre><code>{# Show the structure #}
{% if read_header_vars %}Row 1 (headers): {% for var_info in read_header_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if read_units_vars %}Row 2 (units): {% for var_info in read_units_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if read_data_vars %}Row 3+ (data): {% for var_info in read_data_vars %}{{ var_info.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}...</code></pre>
                        </div>
                      </div>
                    {% endif %}
                  {% else %}
                    <p><em>No read format information available.</em></p>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p><em>No procedures use this file.</em></p>
      {% endif %}
      
      {# Sample Read Format Section - SEPARATE section for Output files to show how multiple procedures can write #}
      {% if iofile.io_type in ['Output', 'Input/Output'] %}
        <h2>Sample File Format</h2>
        <p class="text-muted">This section shows the overall format of the output file, which may be written by multiple procedures (e.g., header in one procedure, data in another).</p>
        
        {% set all_write_vars = [] %}
        {% set header_procs = [] %}
        {% set data_procs = [] %}
        
        {# Collect all write variables from all procedures #}
        {% for proc_info in iofile.procedures %}
          {% set is_header_proc = namespace(value=false) %}
          {% set ops = proc_info.operations %}
          {% if ops.timeline %}
            {% for op in ops.timeline %}
              {% if op.kind == 'write' and op.parameters %}
                {% for param in op.parameters %}
                  {% if '_hdr' in param.lower() or '_units' in param.lower() %}
                    {% set is_header_proc.value = true %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if is_header_proc.value %}
            {% set _ = header_procs.append(proc_info) %}
          {% else %}
            {% set _ = data_procs.append(proc_info) %}
          {% endif %}
        {% endfor %}
        
        {# Process header procedures first, then data procedures #}
        {% for proc_info in header_procs + data_procs %}
          {% set proc = proc_info.procedure %}
          {% set ops = proc_info.operations %}
          {% if ops.timeline %}
            {% for op in ops.timeline %}
              {% if op.kind == 'write' and op.parameters %}
                {% for param in op.parameters %}
                  {% set param_info = {} %}
                  {% set _ = param_info.update({'full_name': param, 'procedure': proc, 'line': op.line}) %}
                  
                  {# Extract base variable name and component #}
                  {% set base_name = none %}
                  {% set component_name = none %}
                  {% if '%' in param %}
                    {% set parts = param.split('%') %}
                    {% set base_name = parts[0].split('(')[0] %}
                    {% set component_name = parts[-1].split('(')[0] %}
                  {% else %}
                    {% set base_name = param.split('(')[0] %}
                    {% set component_name = none %}
                  {% endif %}
                  {% set _ = param_info.update({'base_name': base_name, 'component_name': component_name}) %}
                  
                  {% set _ = all_write_vars.append(param_info) %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        
        {% if all_write_vars %}
          {# Categorize variables #}
          {% set header_vars = [] %}
          {% set units_vars = [] %}
          {% set data_vars = [] %}
          {% set seen_base_vars = [] %}
          
          {% for var_info in all_write_vars %}
            {% set var_name = var_info.base_name %}
            {% if var_name not in seen_base_vars %}
              {% set _ = seen_base_vars.append(var_name) %}
              {% if '_hdr_units' in var_name.lower() or '_units' in var_name.lower() %}
                {% set _ = units_vars.append(var_info) %}
              {% elif '_hdr' in var_name.lower() %}
                {% set _ = header_vars.append(var_info) %}
              {% else %}
                {% set _ = data_vars.append(var_info) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if header_vars or units_vars or data_vars %}
            {# Build expanded variable list with derived type components #}
            {% set expanded_vars = [] %}
            
            {# Process data_vars to expand derived types #}
            {% for var_info in data_vars %}
              {# Look up the variable definition #}
              {% set found_var = namespace(value=none) %}
              {% if var_info.procedure.variables is defined %}
                {% for v in var_info.procedure.variables %}
                  {% if v.name.lower() == var_info.base_name.lower() %}
                    {% set found_var.value = v %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {% if not found_var.value and var_info.procedure.all_vars is defined %}
                {% if var_info.base_name.lower() in var_info.procedure.all_vars %}
                  {% set found_var.value = var_info.procedure.all_vars[var_info.base_name.lower()] %}
                {% endif %}
              {% endif %}
              
              {# Check if it's a derived type without a component specified #}
              {% if not var_info.component_name and found_var.value and found_var.value.proto and found_var.value.proto|length > 0 %}
                {% set type_obj = found_var.value.proto[0] %}
                {% if type_obj is not string and type_obj.variables is defined %}
                  {# It's a derived type - expand all components #}
                  {% for comp in type_obj.variables %}
                    {% set comp_info = {} %}
                    {% set _ = comp_info.update({'base_name': var_info.base_name, 'component_name': comp.name, 'full_name': var_info.base_name ~ '%' ~ comp.name, 'procedure': var_info.procedure}) %}
                    {% set _ = expanded_vars.append(comp_info) %}
                  {% endfor %}
                {% else %}
                  {# Not a derived type or string type - add as is #}
                  {% set _ = expanded_vars.append(var_info) %}
                {% endif %}
              {% else %}
                {# Already has a component or not a derived type - add as is #}
                {% set _ = expanded_vars.append(var_info) %}
              {% endif %}
            {% endfor %}
            
            <div class="card">
              <div class="card-body">
                <pre><code>{# Show the structure #}
{% if header_vars %}Row 1 (headers): {% for var_info in header_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %} [written by {% for proc_info in header_procs %}{{ proc_info.procedure.name }}{% if not loop.last %}, {% endif %}{% endfor %}]

{% endif %}{% if units_vars %}Row 2 (units): {% for var_info in units_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if expanded_vars %}Row 3+ (data): {% for var_info in expanded_vars %}{{ var_info.full_name }}{% if not loop.last %}, {% endif %}{% endfor %} [written by {% for proc_info in data_procs %}{{ proc_info.procedure.name }}{% if not loop.last %}, {% endif %}{% endfor %}]

{% endif %}...</code></pre>
                <p class="text-muted"><small>Note: This format shows how multiple procedures may contribute to the same output file (e.g., one writes the header, another writes the data). When a derived type is written in full, all its components are listed individually.</small></p>
              </div>
            </div>
          {% endif %}
        {% else %}
          <p><em>No file format information available.</em></p>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endblock %}
