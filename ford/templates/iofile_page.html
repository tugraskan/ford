<!-- -*- mode: jinja2 -*- -->

{% extends "base.html" %}
{% block title %}{{ iofile.io_filename }} &ndash; {{ project }} {% endblock title %}
{% block body %}
  {% import 'macros.html' as macros %}
  <div class="row">
    <h1>{{ iofile.io_filename }}
      <small>I/O File</small>
    </h1>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <dl class="dl-horizontal">
            <dt>Unit Number</dt>
            <dd><code>{{ iofile.unit }}</code></dd>
            <dt>I/O Type</dt>
            <dd>
              {% if iofile.io_type == 'Input/Output' %}
                <span class="badge bg-info">Input/Output</span>
              {% elif iofile.io_type == 'Input' %}
                <span class="badge bg-success">Input</span>
              {% elif iofile.io_type == 'Output' %}
                <span class="badge bg-primary">Output</span>
              {% else %}
                <span class="badge bg-secondary">Unknown</span>
              {% endif %}
            </dd>
            <dt>Total Operations</dt>
            <dd>{{ iofile.operations|length }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      {{ macros.sidebar(project, iofile) }}
    </div>
    
    <div class="col-md-9" id='text'>
      <h2>Procedures Using This File</h2>
      {% if iofile.procedures %}
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Procedure</th>
              <th>Location</th>
              <th>Unit</th>
              <th>Operations</th>
            </tr>
          </thead>
          <tbody>
            {% for proc_info in iofile.procedures %}
              {% set proc = proc_info.procedure %}
              {% set ops = proc_info.operations %}
              <tr>
                <td>{{ proc | relurl(page_url) }}</td>
                <td>{{ proc.parent | relurl(page_url) }}</td>
                <td>
                  <code>{{ ops.unit }}</code>
                  {% if ops.unit_resolved %}
                    <br><small class="text-muted">â†’ {{ ops.unit_resolved }}</small>
                  {% endif %}
                </td>
                <td>
                  {% if ops.timeline %}
                    {% set has_read = namespace(value=false) %}
                    {% set has_write = namespace(value=false) %}
                    {% for op in ops.timeline %}
                      {% if op.kind == 'read' %}
                        {% set has_read.value = true %}
                      {% elif op.kind == 'write' %}
                        {% set has_write.value = true %}
                      {% endif %}
                    {% endfor %}
                    {{ ops.timeline|length }} operation(s):
                    {% if has_read.value %}
                      <span class="badge bg-success">Read</span>
                    {% endif %}
                    {% if has_write.value %}
                      <span class="badge bg-primary">Write</span>
                    {% endif %}
                  {% else %}
                    <em>n/a</em>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p><em>No procedures use this file.</em></p>
      {% endif %}
      
      {# Variables Section - show variables for Output and Input/Output files #}
      {% if iofile.io_type in ['Output', 'Input/Output'] %}
      <h2>Variables Written to This File</h2>
      {% set all_vars = {} %}
      {% set var_order = [] %}
      
      {# Separate procedures into header-writing and data-writing #}
      {% set header_procs = [] %}
      {% set data_procs = [] %}
      
      {% for proc_info in iofile.procedures %}
        {% set is_header_proc = namespace(value=false) %}
        {% set ops = proc_info.operations %}
        {% if ops.timeline %}
          {% for op in ops.timeline %}
            {% if op.kind == 'write' and op.parameters %}
              {% for param in op.parameters %}
                {% if '_hdr' in param.lower() or '_units' in param.lower() %}
                  {% set is_header_proc.value = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if is_header_proc.value %}
          {% set _ = header_procs.append(proc_info) %}
        {% else %}
          {% set _ = data_procs.append(proc_info) %}
        {% endif %}
      {% endfor %}
      
      {# Process header procedures first, then data procedures #}
      {% for proc_info in header_procs + data_procs %}
        {% set proc = proc_info.procedure %}
        {% set ops = proc_info.operations %}
        {% if ops.timeline %}
          {% for op in ops.timeline %}
            {% if op.kind == 'write' and op.parameters %}
              {% for param in op.parameters %}
                {# Extract base variable name (remove array indices, type components) #}
                {% set base_var = param.split('(')[0].split('%')[-1] %}
                {% if base_var not in all_vars %}
                  {% set _ = all_vars.update({base_var: {'full_name': param, 'procedure': proc, 'line': op.line}}) %}
                  {% set _ = var_order.append(base_var) %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      {% if all_vars %}
        <p class="text-muted">The following variables are written to this file across all procedures (ordered by occurrence in code):</p>
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Variable</th>
              <th>Type</th>
              <th>Default Value</th>
              <th>Procedure</th>
            </tr>
          </thead>
          <tbody>
            {% for var_name in var_order %}
              {% set var_info = all_vars[var_name] %}
              <tr>
                <td><code>{{ var_info.full_name }}</code></td>
                <td>
                  {% set found_var = namespace(value=none) %}
                  {# Extract the base variable name and component if accessing a derived type #}
                  {% set is_component = namespace(value=false) %}
                  {% set base_name = var_name %}
                  {% set component_name = none %}
                  {% if '%' in var_info.full_name %}
                    {% set parts = var_info.full_name.split('%') %}
                    {% set base_name = parts[0].split('(')[0] %}
                    {% set component_name = parts[-1] %}
                    {% set is_component.value = true %}
                  {% endif %}
                  
                  {# First try to find base variable in procedure's local variables #}
                  {% if var_info.procedure.variables is defined %}
                    {% for v in var_info.procedure.variables %}
                      {% if v.name.lower() == base_name.lower() %}
                        {% set found_var.value = v %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {# If not found locally, try module variables via all_vars #}
                  {% if not found_var.value and var_info.procedure.all_vars is defined %}
                    {% if base_name.lower() in var_info.procedure.all_vars %}
                      {% set found_var.value = var_info.procedure.all_vars[base_name.lower()] %}
                    {% endif %}
                  {% endif %}
                  
                  {# Display the type #}
                  {% if found_var.value %}
                    {% if is_component.value %}
                      {# For component access, show base type + component #}
                      <code>{{ found_var.value.full_type }}%{{ component_name }}</code>
                    {% else %}
                      <code>{{ found_var.value.full_type }}</code>
                    {% endif %}
                  {% else %}
                    <em>unknown</em>
                  {% endif %}
                </td>
                <td>
                  {% if found_var.value and found_var.value.initial %}
                    <code>{{ found_var.value.initial }}</code>
                  {% else %}
                    <em>-</em>
                  {% endif %}
                </td>
                <td>{{ var_info.procedure | relurl(page_url) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        {# Sample File Format Section #}
        <h3>Sample File Format</h3>
        <p class="text-muted">The following shows an example of how this file would be formatted:</p>
        <div class="card">
          <div class="card-body">
            <pre><code>{# First, show which variables write headers vs data #}
{# Look for header variables (typically aqu_hdr, ch_hdr, etc.) #}
{% set header_vars = [] %}
{% set units_vars = [] %}
{% set data_vars = [] %}
{% for var_name in var_order %}
  {% set var_info = all_vars[var_name] %}
  {% if '_hdr_units' in var_name.lower() %}
    {% set _ = units_vars.append(var_name) %}
  {% elif '_hdr' in var_name.lower() %}
    {% set _ = header_vars.append(var_name) %}
  {% else %}
    {% set _ = data_vars.append(var_name) %}
  {% endif %}
{% endfor %}
{# Show the structure #}
{% if header_vars %}Row 1 (headers): {% for var in header_vars %}{{ var }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if units_vars %}Row 2 (units): {% for var in units_vars %}{{ var }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if data_vars %}Row 3+ (data): {% for var in data_vars %}{{ all_vars[var].full_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}...</code></pre>
            <p class="text-muted"><small>Note: Header and units variables (like <code>aqu_hdr</code>) are typically structured types that expand to multiple columns when written.</small></p>
          </div>
        </div>
      {% else %}
        <p><em>No variables information available.</em></p>
      {% endif %}
      {% endif %}
      
      <h2>I/O Operations by Procedure</h2>
      {% if iofile.procedures %}
        {% for proc_info in iofile.procedures %}
          {% set proc = proc_info.procedure %}
          {% set ops = proc_info.operations %}
          <h3>{{ proc.name }}
            <small class="text-muted">
              (from {{ proc.parent.name if proc.parent else 'unknown' }})
            </small>
          </h3>
          {% if ops.timeline %}
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Line</th>
                  <th>Operation</th>
                  <th>Raw Statement</th>
                </tr>
              </thead>
              <tbody>
                {% for op in ops.timeline %}
                  <tr>
                    <td>{% if op.line %}{{ op.line }}{% else %}-{% endif %}</td>
                    <td>
                      {% if op.kind == 'read' %}
                        <span class="badge bg-success">Read</span>
                      {% elif op.kind == 'write' %}
                        <span class="badge bg-primary">Write</span>
                      {% elif op.kind == 'open' %}
                        <span class="badge bg-info">Open</span>
                      {% elif op.kind == 'close' %}
                        <span class="badge bg-secondary">Close</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ op.kind }}</span>
                      {% endif %}
                    </td>
                    <td><code>{{ op.raw }}</code></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p><em>No operations recorded for this procedure.</em></p>
          {% endif %}
        {% endfor %}
      {% else %}
        <p><em>No procedures use this file.</em></p>
      {% endif %}
    </div>
  </div>
{% endblock %}
