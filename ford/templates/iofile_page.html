<!-- -*- mode: jinja2 -*- -->

{% extends "base.html" %}
{% block title %}{{ iofile.io_filename }} &ndash; {{ project }} {% endblock title %}
{% block body %}
  {% import 'macros.html' as macros %}
  <div class="row">
    <h1>{{ iofile.io_filename }}
      <small>I/O File</small>
    </h1>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <dl class="dl-horizontal">
            <dt>Unit Number</dt>
            <dd><code>{{ iofile.unit }}</code></dd>
            <dt>I/O Type</dt>
            <dd>
              {% if iofile.io_type == 'Input/Output' %}
                <span class="badge bg-info">Input/Output</span>
              {% elif iofile.io_type == 'Input' %}
                <span class="badge bg-success">Input</span>
              {% elif iofile.io_type == 'Output' %}
                <span class="badge bg-primary">Output</span>
              {% else %}
                <span class="badge bg-secondary">Unknown</span>
              {% endif %}
            </dd>
            <dt>Total Operations</dt>
            <dd>{{ iofile.operations|length }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      {{ macros.sidebar(project, iofile) }}
    </div>
    
    <div class="col-md-9" id='text'>
      <h2>Procedures Using This File</h2>
      {% if iofile.procedures %}
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Procedure</th>
              <th>Location</th>
              <th>Unit</th>
              <th>Operations</th>
            </tr>
          </thead>
          <tbody>
            {% for proc_info in iofile.procedures %}
              {% set proc = proc_info.procedure %}
              {% set ops = proc_info.operations %}
              <tr>
                <td>{{ proc | relurl(page_url) }}</td>
                <td>{{ proc.parent | relurl(page_url) }}</td>
                <td>
                  <code>{{ ops.unit }}</code>
                  {% if ops.unit_resolved %}
                    <br><small class="text-muted">â†’ {{ ops.unit_resolved }}</small>
                  {% endif %}
                </td>
                <td>
                  {% if ops.timeline %}
                    {% set has_read = namespace(value=false) %}
                    {% set has_write = namespace(value=false) %}
                    {% for op in ops.timeline %}
                      {% if op.kind == 'read' %}
                        {% set has_read.value = true %}
                      {% elif op.kind == 'write' %}
                        {% set has_write.value = true %}
                      {% endif %}
                    {% endfor %}
                    {{ ops.timeline|length }} operation(s):
                    {% if has_read.value %}
                      <span class="badge bg-success">Read</span>
                    {% endif %}
                    {% if has_write.value %}
                      <span class="badge bg-primary">Write</span>
                    {% endif %}
                  {% else %}
                    <em>n/a</em>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p><em>No procedures use this file.</em></p>
      {% endif %}
      
      {# Variables Section - show variables for Output and Input/Output files #}
      {% if iofile.io_type in ['Output', 'Input/Output'] %}
      <h2>Variables Written to This File</h2>
      {% set all_vars = [] %}
      
      {# Separate procedures into header-writing and data-writing #}
      {% set header_procs = [] %}
      {% set data_procs = [] %}
      
      {% for proc_info in iofile.procedures %}
        {% set is_header_proc = namespace(value=false) %}
        {% set ops = proc_info.operations %}
        {% if ops.timeline %}
          {% for op in ops.timeline %}
            {% if op.kind == 'write' and op.parameters %}
              {% for param in op.parameters %}
                {% if '_hdr' in param.lower() or '_units' in param.lower() %}
                  {% set is_header_proc.value = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if is_header_proc.value %}
          {% set _ = header_procs.append(proc_info) %}
        {% else %}
          {% set _ = data_procs.append(proc_info) %}
        {% endif %}
      {% endfor %}
      
      {# Process header procedures first, then data procedures #}
      {% for proc_info in header_procs + data_procs %}
        {% set proc = proc_info.procedure %}
        {% set ops = proc_info.operations %}
        {% if ops.timeline %}
          {% for op in ops.timeline %}
            {% if op.kind == 'write' and op.parameters %}
              {% for param in op.parameters %}
                {# Parse the parameter to extract its components #}
                {% set param_info = {} %}
                {% set _ = param_info.update({'full_name': param, 'procedure': proc, 'line': op.line}) %}
                
                {# Extract array name and indices if present: e.g., aqu_a(iaq) or ob(iob)%name #}
                {% set array_name = none %}
                {% set array_index = none %}
                {% if '(' in param %}
                  {% set paren_parts = param.split('(', 1) %}
                  {% set before_paren = paren_parts[0] %}
                  {% set after_paren = paren_parts[1].rsplit(')', 1)[0] if ')' in paren_parts[1] else paren_parts[1] %}
                  {% if '%' not in before_paren %}
                    {# Simple array like aqu_a(iaq) #}
                    {% set array_name = before_paren %}
                    {% set array_index = after_paren %}
                  {% else %}
                    {# Component with array like ob(iob)%name - extract array from first part #}
                    {% set parts = before_paren.split('%') %}
                    {% set array_name = parts[0] %}
                    {% set array_index = after_paren.split('%')[0] if '%' in after_paren else after_paren %}
                  {% endif %}
                {% endif %}
                {% set _ = param_info.update({'array_name': array_name, 'array_index': array_index}) %}
                
                {# Extract base variable name and component #}
                {% set base_name = none %}
                {% set component_name = none %}
                {% if '%' in param %}
                  {# Has component access like time%day or ob(iob)%name #}
                  {% set parts = param.split('%') %}
                  {% set base_name = parts[0].split('(')[0] %}
                  {% set component_name = parts[-1].split('(')[0] %}
                {% else %}
                  {# Simple variable or array like iaq or aqu_a(iaq) #}
                  {% set base_name = param.split('(')[0] %}
                  {% set component_name = none %}
                {% endif %}
                {% set _ = param_info.update({'base_name': base_name, 'component_name': component_name}) %}
                
                {# Add to list #}
                {% set _ = all_vars.append(param_info) %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      {% if all_vars %}
        <p class="text-muted">The following variables are written to this file in order (one row per write operation parameter):</p>
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Module</th>
              <th>Derived Type</th>
              <th>Array Name</th>
              <th>Data Type</th>
              <th>Component Name</th>
              <th>Default Value / Initial</th>
              <th>Procedure</th>
            </tr>
          </thead>
          <tbody>
            {% for var_info in all_vars %}
              <tr>
                {# Column 1: Module - find which module the base variable belongs to #}
                <td>
                  {% set found_var = namespace(value=none) %}
                  {% set is_local = namespace(value=false) %}
                  
                  {# First try to find base variable in procedure's local variables #}
                  {% if var_info.procedure.variables is defined %}
                    {% for v in var_info.procedure.variables %}
                      {% if v.name.lower() == var_info.base_name.lower() %}
                        {% set found_var.value = v %}
                        {% set is_local.value = true %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {# If not found locally, try module variables via all_vars #}
                  {% if not found_var.value and var_info.procedure.all_vars is defined %}
                    {% if var_info.base_name.lower() in var_info.procedure.all_vars %}
                      {% set found_var.value = var_info.procedure.all_vars[var_info.base_name.lower()] %}
                    {% endif %}
                  {% endif %}
                  
                  {% if is_local.value %}
                    Local
                  {% elif found_var.value and found_var.value.parent %}
                    {# Check if parent is a module (not a procedure) #}
                    {% if found_var.value.parent.obj == 'module' %}
                      {{ found_var.value.parent | relurl(page_url) }}
                    {% else %}
                      Local
                    {% endif %}
                  {% else %}
                    <em>unknown</em>
                  {% endif %}
                </td>
                
                {# Column 2: Derived Type - link to the type if it's a derived type #}
                <td>
                  {% if found_var.value and found_var.value.proto and found_var.value.proto|length > 0 %}
                    {% set type_obj = found_var.value.proto[0] %}
                    {% if type_obj is string %}
                      <code>{{ type_obj }}</code>
                    {% else %}
                      {{ type_obj | relurl(page_url) }}
                    {% endif %}
                  {% else %}
                    NA
                  {% endif %}
                </td>
                
                {# Column 3: Array Name - if applicable #}
                <td>
                  {% if var_info.array_name %}
                    <code>{{ var_info.array_name }}</code>
                  {% else %}
                    <em>-</em>
                  {% endif %}
                </td>
                
                {# Column 4: Data Type - get the type of the component or base variable #}
                <td>
                  {% if var_info.component_name and found_var.value %}
                    {# Need to find the component type within the derived type #}
                    {% set component_var = namespace(value=none) %}
                    {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                      {% set type_obj = found_var.value.proto[0] %}
                      {% if type_obj is not string and type_obj.variables is defined %}
                        {% for comp in type_obj.variables %}
                          {% if comp.name.lower() == var_info.component_name.lower() %}
                            {% set component_var.value = comp %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endif %}
                    {% if component_var.value %}
                      <code>{{ component_var.value.full_type }}</code>
                    {% else %}
                      <em>unknown</em>
                    {% endif %}
                  {% elif found_var.value %}
                    <code>{{ found_var.value.full_type }}</code>
                  {% else %}
                    <em>unknown</em>
                  {% endif %}
                </td>
                
                {# Column 5: Component Name #}
                <td>
                  {% if var_info.component_name %}
                    <code>{{ var_info.component_name }}</code>
                  {% else %}
                    <em>-</em>
                  {% endif %}
                </td>
                
                {# Column 6: Default Value / Initial #}
                <td>
                  {% if var_info.component_name and found_var.value %}
                    {# Need to find the component initial value within the derived type #}
                    {% set component_var = namespace(value=none) %}
                    {% if found_var.value.proto and found_var.value.proto|length > 0 %}
                      {% set type_obj = found_var.value.proto[0] %}
                      {% if type_obj is not string and type_obj.variables is defined %}
                        {% for comp in type_obj.variables %}
                          {% if comp.name.lower() == var_info.component_name.lower() %}
                            {% set component_var.value = comp %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endif %}
                    {% if component_var.value and component_var.value.initial %}
                      <code>{{ component_var.value.initial }}</code>
                    {% else %}
                      <em>-</em>
                    {% endif %}
                  {% elif found_var.value and found_var.value.initial %}
                    <code>{{ found_var.value.initial }}</code>
                  {% else %}
                    <em>-</em>
                  {% endif %}
                </td>
                
                {# Column 7: Procedure #}
                <td>{{ var_info.procedure | relurl(page_url) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        {# Sample File Format Section #}
        <h3>Sample File Format</h3>
        
        {# First, categorize variables - use base_name for categorization #}
        {% set header_vars = [] %}
        {% set units_vars = [] %}
        {% set data_vars = [] %}
        {% set seen_vars = [] %}
        
        {% for var_info in all_vars %}
          {% set var_name = var_info.base_name %}
          {% if var_name not in seen_vars %}
            {% set _ = seen_vars.append(var_name) %}
            {% if '_hdr_units' in var_name.lower() or '_units' in var_name.lower() %}
              {% set _ = units_vars.append(var_info) %}
            {% elif '_hdr' in var_name.lower() %}
              {% set _ = header_vars.append(var_info) %}
            {% else %}
              {% set _ = data_vars.append(var_info) %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {# Show transposed header tables for header and units variables #}
        {% if header_vars or units_vars %}
          {% for var_info in header_vars + units_vars %}
            {% set var_name = var_info.base_name %}
            {# Try to find the variable in the procedure #}
            {% set found_var = namespace(value=none) %}
            {% if var_info.procedure.variables is defined %}
              {% for v in var_info.procedure.variables %}
                {% if v.name.lower() == var_name.lower() %}
                  {% set found_var.value = v %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {# If not found locally, try module variables via all_vars #}
            {% if not found_var.value and var_info.procedure.all_vars is defined %}
              {% if var_name.lower() in var_info.procedure.all_vars %}
                {% set found_var.value = var_info.procedure.all_vars[var_name.lower()] %}
              {% endif %}
            {% endif %}
            
            {# Create the header table if we found the variable #}
            {% if found_var.value %}
              {% set header_table = found_var.value | create_header_table %}
              {% if header_table %}
                <h4>{{ var_name }} ({{ found_var.value.full_type }})</h4>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered">
                    <thead>
                      <tr>
                        <th></th>
                        {% for field in header_table.fields %}
                        <th>{{ field }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><strong>Attributes</strong></td>
                        {% for attr in header_table.attributes %}
                        <td><code>{{ attr }}</code></td>
                        {% endfor %}
                      </tr>
                      <tr>
                        <td><strong>Name</strong></td>
                        {% for name in header_table.names %}
                        <td>{{ name }}</td>
                        {% endfor %}
                      </tr>
                      <tr>
                        <td><strong>Initial</strong></td>
                        {% for initial in header_table.initials %}
                        <td><code>{{ initial }}</code></td>
                        {% endfor %}
                      </tr>
                      <tr>
                        <td><strong>Type</strong></td>
                        {% for type in header_table.types %}
                        <td><code>{{ type }}</code></td>
                        {% endfor %}
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {# Show traditional format info #}
        <p class="text-muted">The following shows an example of how this file would be formatted:</p>
        <div class="card">
          <div class="card-body">
            <pre><code>{# Show the structure #}
{% if header_vars %}Row 1 (headers): {% for var_info in header_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if units_vars %}Row 2 (units): {% for var_info in units_vars %}{{ var_info.base_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}{% if data_vars %}Row 3+ (data): {% for var_info in data_vars %}{{ var_info.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}...</code></pre>
            <p class="text-muted"><small>Note: Header and units variables (like <code>aqu_hdr</code>) are typically structured types that expand to multiple columns when written.</small></p>
          </div>
        </div>
      {% else %}
        <p><em>No variables information available.</em></p>
      {% endif %}
      {% endif %}
      
      <h2>I/O Operations by Procedure</h2>
      {% if iofile.procedures %}
        {% for proc_info in iofile.procedures %}
          {% set proc = proc_info.procedure %}
          {% set ops = proc_info.operations %}
          <h3>{{ proc.name }}
            <small class="text-muted">
              (from {{ proc.parent.name if proc.parent else 'unknown' }})
            </small>
          </h3>
          {% if ops.timeline %}
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Line</th>
                  <th>Operation</th>
                  <th>Raw Statement</th>
                </tr>
              </thead>
              <tbody>
                {% for op in ops.timeline %}
                  <tr>
                    <td>{% if op.line %}{{ op.line }}{% else %}-{% endif %}</td>
                    <td>
                      {% if op.kind == 'read' %}
                        <span class="badge bg-success">Read</span>
                      {% elif op.kind == 'write' %}
                        <span class="badge bg-primary">Write</span>
                      {% elif op.kind == 'open' %}
                        <span class="badge bg-info">Open</span>
                      {% elif op.kind == 'close' %}
                        <span class="badge bg-secondary">Close</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ op.kind }}</span>
                      {% endif %}
                    </td>
                    <td><code>{{ op.raw }}</code></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p><em>No operations recorded for this procedure.</em></p>
          {% endif %}
        {% endfor %}
      {% else %}
        <p><em>No procedures use this file.</em></p>
      {% endif %}
    </div>
  </div>
{% endblock %}
