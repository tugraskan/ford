<!-- -*- mode: jinja2 -*- -->

{% extends "base.html" %}
{% block title %}{{ procedure.name }} &ndash; {{ project }}{% endblock title %}
{% block body %}
  {% import 'macros.html' as macros %}
  <div class="row">
    <h1>{{ procedure.name }}
      <small>{%if procedure.module %}Module {% endif %}{% if not procedure.mp %}{{ procedure.proctype }}{% else %}Procedure{% endif %}</small>
      {{ macros.deprecated(procedure) }}
    </h1>
    {{
    macros.info_bar(procedure, incl_src, project_url, procedure.lines_description(project.proc_lines)) }}
  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    {{ macros.sidebar(project,procedure) }}
    </div>
    
    <div class="col-md-9" id='text'>
    <h2>{{ macros.proc_line(procedure,False) }}</h2>

    {# Section 0: Purpose - placeholder for future @!purpose directive #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#purpose-section" 
         aria-expanded="false" 
         aria-controls="purpose-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Purpose
        </h3>
      </a>
      <div id="purpose-section" class="collapse">
        <div class="card-body">
          {# TODO: This will be populated by @!purpose directive in the future #}
          <em>n/a</em>
        </div>
      </div>
    </div>

    {# Section 1: Called From - with graph and subsection for Arguments #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#called-from-section" 
         aria-expanded="true" 
         aria-controls="called-from-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Called From
        </h3>
      </a>
      <div id="called-from-section" class="collapse show">
        <div class="card-body">
          {% if procedure.calledby or procedure.calledbygraph %}
            {% if procedure.calledby %}
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item">
                <ul class="list-inline">
                  {% for caller in procedure.calledby %}
                    <li class="list-inline-item">{{ caller | relurl(page_url) }}</li>
                  {% endfor %}
                </ul>
              </li>
            </ul>
            {% endif %}
            
            {% if procedure.calledbygraph %}
            <p class="text-muted mb-3">
              Procedures that call this {{ procedure.proctype }}. This shows the call stack back to the main program.
            </p>
            <div class="depgraph">
              {{ procedure.calledbygraph }}
            </div>
            {% endif %}
          {% else %}
            <em>n/a</em>
          {% endif %}

          {# 1a. Arguments as subsection #}
          <h4 class="mt-4 mb-3">Arguments</h4>
          {% if procedure.args %}
            {{ macros.variable_list(procedure.args, intent=True) }}
          {% else %}
            <em>n/a</em>
          {% endif %}
        </div>
      </div>
    </div>

    {# Section 2: Uses - with graph and subsection for Outside Variables and Types #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#uses-section" 
         aria-expanded="false" 
         aria-controls="uses-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Uses
        </h3>
      </a>
      <div id="uses-section" class="collapse">
        <div class="card-body">
          {% if procedure.uses or procedure.ancestry %}
            <ul class="list-group list-group-flush mb-3">
              {% if procedure.uses %}
                <li class="list-group-item">
                  <ul class="list-inline">
                    {% for use in procedure.uses %}
                      <li class="list-inline-item">{{ use | relurl(page_url) }}</li>
                    {% endfor %}
                  </ul>
                </li>
              {% endif %}
              {% if procedure.ancestry %}
                <li class="list-group-item">
                  <ul class="list-inline">
                    <li><h5>Ancestors:</h5></li>
                    {% for ancestor in procedure.ancestry %}
                      <li class="list-inline-item">{{ ancestor | relurl(page_url) }}</li>
                      {% if not loop.last -%}<li>:</li>{%- endif %}
                    {% endfor %}
                  </ul>
                </li>
              {% endif %}
              {% if procedure.usesgraph %}
                <li class="list-group-item">
                  {{ procedure.usesgraph }}
                </li>
              {% endif %}
            </ul>
          {% else %}
            <em>n/a</em>
          {% endif %}

          {# 2a. Outside Variables and Types as subsection #}
          <h4 class="mt-4 mb-3">Outside Variables and Types</h4>
          {% if procedure.outside_variables_used %}
            {{ macros.outside_variables_list(procedure.outside_variables_used) }}
          {% else %}
            <em>n/a</em>
          {% endif %}
        </div>
      </div>
    </div>

    {# Section 3: I/O - keep as is #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#inputs-outputs-section" 
         aria-expanded="false" 
         aria-controls="inputs-outputs-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>I/O
        </h3>
      </a>
      <div id="inputs-outputs-section" class="collapse">
        <div class="card-body">
          {% if procedure.io_operations %}
          <p class="text-muted mb-3">
            I/O units used in this subroutine.
          </p>
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>Unit</th>
                <th>Type</th>
                <th>Filename</th>
              </tr>
            </thead>
            <tbody>
              {% for file_key, operations in procedure.io_operations.items() %}
              <tr>
                <td>
                  {% if operations.unit %}
                    <code>{{ operations.unit }}</code>
                    {% if operations.unit_resolved %}
                      <br><small class="text-muted">→ {{ operations.unit_resolved }}</small>
                    {% endif %}
                  {% else %}
                    <em>not specified</em>
                  {% endif %}
                </td>
                <td>
                  {% if operations.timeline %}
                    {% set has_read = namespace(value=false) %}
                    {% set has_write = namespace(value=false) %}
                    {% for op in operations.timeline %}
                      {% if op.kind == 'read' %}
                        {% set has_read.value = true %}
                      {% elif op.kind == 'write' %}
                        {% set has_write.value = true %}
                      {% endif %}
                    {% endfor %}
                    {% if has_read.value and has_write.value %}
                      <span class="badge bg-info">Input/Output</span>
                    {% elif has_read.value %}
                      <span class="badge bg-success">Input</span>
                    {% elif has_write.value %}
                      <span class="badge bg-primary">Output</span>
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  {% if operations.filename %}
                    <code>{{ operations.filename }}</code>
                    {% if operations.filename_resolved %}
                      <br><small class="text-muted">→ {{ operations.filename_resolved }}</small>
                    {% endif %}
                  {% else %}
                    <em>not specified</em>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
            <em>n/a</em>
          {% endif %}
        </div>
      </div>
    </div>

    {# Section 4: Local Variables #}
    {% if procedure.local_variables %}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#local-variables-section" 
         aria-expanded="false" 
         aria-controls="local-variables-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Local Variables
        </h3>
      </a>
      <div id="local-variables-section" class="collapse">
        <div class="card-body">
          {{ macros.variable_list(procedure.local_variables, permission=True) }}
        </div>
      </div>
    </div>
    {% endif %}

    {# Section 5: Control Flow - with graphs and bang comments integrated into logic blocks #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#control-flow-section" 
         aria-expanded="false" 
         aria-controls="control-flow-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Control Flow
        </h3>
      </a>
      <div id="control-flow-section" class="collapse">
        <div class="card-body">
          {# Procedure Badges Section - moved here from top #}
          {% if procedure.procedure_badges %}
          <div class="mb-4">
            {% if procedure.procedure_badges.complexity_level or procedure.procedure_badges.max_depth or procedure.procedure_badges.early_exits %}
            <div class="mb-2">
              <strong>Complexity Indicators:</strong>
              {% if procedure.procedure_badges.complexity_level %}
              <span class="badge {% if procedure.procedure_badges.complexity_level == 'Simple' %}bg-success{% elif procedure.procedure_badges.complexity_level == 'Moderate' %}bg-warning text-dark{% else %}bg-danger{% endif %} me-1">
                {{ procedure.procedure_badges.complexity_level }}
              </span>
              {% endif %}
              {% if procedure.procedure_badges.max_depth > 0 %}
              <span class="badge bg-info text-dark me-1" title="Maximum nesting depth">
                Depth: {{ procedure.procedure_badges.max_depth }}
              </span>
              {% endif %}
              {% if procedure.procedure_badges.early_exits > 0 %}
              <span class="badge bg-secondary me-1" title="Number of RETURN statements">
                Early Exits: {{ procedure.procedure_badges.early_exits }}
              </span>
              {% endif %}
            </div>
            {% endif %}
            
            {% if procedure.procedure_badges.features %}
            <div class="mb-2">
              <strong>Features:</strong>
              {% for feature in procedure.procedure_badges.features %}
              <span class="badge bg-primary me-1">{{ feature }}</span>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if procedure.procedure_badges.keywords %}
            <div class="mb-2">
              <strong>Fortran Keywords:</strong>
              {% for keyword in procedure.procedure_badges.keywords %}
              <span class="badge bg-light text-dark border me-1">{{ keyword }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}
          
          {% if procedure.controlflowtgraph_svg %}
          <h4>Control Flow Graph</h4>
          <p class="text-muted mb-3">
            Visual representation of the execution flow within this procedure. Use mouse wheel to zoom, drag to pan.
          </p>
          <div class="depgraph" id="control-flow-graph-container" style="border: 1px solid #ddd; overflow: auto; max-height: 600px;">
            {{ procedure.controlflowtgraph_svg }}
          </div>
          <div class="mt-3 mb-4">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetControlFlowZoom()">Reset Zoom</button>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#ControlFlowGraph-help-text">Help</a>
          </div>
          <script>
            (function() {
              const container = document.getElementById('control-flow-graph-container');
              const svg = container.querySelector('svg');
              if (svg) {
                svg.style.cursor = 'grab';
                let scale = 1;
                let panning = false;
                let pointX = 0;
                let pointY = 0;
                let start = { x: 0, y: 0 };
                
                // Enable zoom on mouse wheel
                container.addEventListener('wheel', function(e) {
                  e.preventDefault();
                  const xs = (e.clientX - pointX) / scale;
                  const ys = (e.clientY - pointY) / scale;
                  const delta = e.deltaY > 0 ? 0.9 : 1.1;
                  scale *= delta;
                  scale = Math.min(Math.max(0.1, scale), 10);
                  pointX = e.clientX - xs * scale;
                  pointY = e.clientY - ys * scale;
                  svg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                }, { passive: false });
                
                // Enable panning
                svg.addEventListener('mousedown', function(e) {
                  svg.style.cursor = 'grabbing';
                  panning = true;
                  start = { x: e.clientX - pointX, y: e.clientY - pointY };
                });
                
                svg.addEventListener('mouseup', function() {
                  svg.style.cursor = 'grab';
                  panning = false;
                });
                
                svg.addEventListener('mousemove', function(e) {
                  if (!panning) return;
                  e.preventDefault();
                  pointX = e.clientX - start.x;
                  pointY = e.clientY - start.y;
                  svg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                });
                
                svg.addEventListener('mouseleave', function() {
                  panning = false;
                  svg.style.cursor = 'grab';
                });
                
                window.resetControlFlowZoom = function() {
                  scale = 1;
                  pointX = 0;
                  pointY = 0;
                  svg.style.transform = '';
                };
              }
            })();
          </script>
          <div class="modal fade" id="ControlFlowGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">Control Flow Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Control flow graph showing the execution flow within the procedure. Nodes of different shapes and colors represent:</p>
                  
                  <h5>Control Flow Structures</h5>
                  <ul>
                    <li><span style="background-color: #90EE90; padding: 2px 8px;">Entry point</span></li>
                    <li><span style="background-color: #FFB6C1; padding: 2px 8px;">Exit point</span></li>
                    <li><span style="background-color: #87CEEB; padding: 2px 8px;">IF condition (diamond)</span></li>
                    <li><span style="background-color: #DDA0DD; padding: 2px 8px;">DO loop (diamond)</span></li>
                    <li><span style="background-color: #F0E68C; padding: 2px 8px;">SELECT CASE (diamond)</span></li>
                    <li><span style="background-color: #FFE4B5; padding: 2px 8px;">CASE block</span></li>
                    <li><span style="background-color: #E0E0E0; padding: 2px 8px;">Statement block</span></li>
                  </ul>
                  
                  <h5>Keyword Nodes</h5>
                  <p>Each keyword appears as its own node at the point where it occurs in the code:</p>
                  <ul>
                    <li><span style="background-color: #5DADE2; padding: 2px 8px; border-radius: 4px;">I/O operations (OPEN, READ, WRITE, CLOSE, REWIND, INQUIRE)</span> - Rounded rectangle, blue</li>
                    <li><span style="background-color: #52BE80; padding: 2px 8px;">Memory operations (ALLOCATE, DEALLOCATE)</span> - Hexagon, green</li>
                    <li><span style="background-color: #EC7063; padding: 2px 8px;">Early exit (RETURN, EXIT, CYCLE)</span> - Octagon, red</li>
                    <li><span style="border: 2px solid #BB8FCE; padding: 1px 7px; background-color: white; color: #BB8FCE;">Procedure call (CALL)</span> - Rectangle with purple outline</li>
                  </ul>
                  
                  <p>Each keyword node includes its line number in the format: KEYWORD (Lxxx)</p>
                  <p>Arrows show the possible execution paths through the code. Edges from conditions are labeled with 'T' (true) and 'F' (false), or 'loop' and 'exit' for DO loops.</p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if procedure.logic_blocks %}
          <h4>Logic Blocks</h4>
          <p class="text-muted mb-3">
            Control flow structures organized as they appear in the source code. 
            Each block is collapsible to help navigate complex procedures.
          </p>
          {% macro render_statement_with_badges(stmt, keywords, line_num) %}
            {# Render a statement with keyword badges in first column, line number and statement in second #}
            {% if keywords %}
              {% for keyword in keywords %}<span class="badge bg-info text-dark me-1">{{ keyword }}</span>{% endfor %}
            {% endif %}
            {% if keywords and line_num %}    {% endif %}
            {% if line_num %}<span class="text-muted">{{ "%4d" | format(line_num) }}</span> {% endif %}{{ stmt }}
          {% endmacro %}
          
          {% macro render_logic_block(block, index, parent_index='') %}
            {% set block_id = parent_index ~ 'block-' ~ index %}
            {% set indent_class = 'ms-' ~ (block.level * 3) %}
            
            {% if block.block_type == 'if' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-info bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>IF</strong> (<code>{{ block.condition }}</code>) <strong>THEN</strong>
                    {% if block.label %}<span class="badge bg-secondary ms-2">{{ block.label }}</span>{% endif %}
                    {% if block.start_line and block.end_line %}
                      <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                    {% endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% if block.comments %}
                      {% for comment in block.comments %}
                        <div class="text-muted mb-1">
                          <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                          {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                            <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                          {% endif %}
                        </div>
                      {% endfor %}
                    {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
{% endfor %}</code></pre>
                    {% endif %}
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                    <div class="logic-block-endcap border-top border-2 border-info mt-2 pt-2">
                      <strong>END IF</strong>{% if block.label %} <span class="text-muted">{{ block.label }}</span>{% endif %}
                      {% if block.end_line %}<span class="badge bg-light text-dark ms-2">Line {{ block.end_line }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'elseif' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-info bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>ELSE IF</strong> (<code>{{ block.condition }}</code>) <strong>THEN</strong>
                  {%if block.start_line and block.end_line %}
                    <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                  {%  endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% if block.comments %}
                                          {% for comment in block.comments %}
                                            <div class="text-muted mb-1">
                                              <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                                              {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                                                <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                                              {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
                      {% endfor %}</code></pre>
                    {% endif %}
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                    <div class="logic-block-endcap border-top border-2 border-info mt-2 pt-2">
                      <strong>END IF</strong>
                      {% if block.end_line %}<span class="badge bg-light text-dark ms-2">Line {{ block.end_line }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'else' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-info bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>ELSE</strong>
                    {% if block.start_line and block.end_line %}
                      <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                    {% endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% if block.comments %}
                                          {% for comment in block.comments %}
                                            <div class="text-muted mb-1">
                                              <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                                              {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                                                <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                                              {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
                      {% endfor %}</code></pre>
                    {% endif %}
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                    <div class="logic-block-endcap border-top border-2 border-info mt-2 pt-2">
                      <strong>END IF</strong>
                      {% if block.end_line %}<span class="badge bg-light text-dark ms-2">Line {{ block.end_line }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'do' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-warning bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>DO</strong> <code>{{ block.condition }}</code>
                    {% if block.label %}<span class="badge bg-secondary ms-2">{{ block.label }}</span>{% endif %}
                    {% if block.start_line and block.end_line %}
                      <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                    {% endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% if block.comments %}
                                          {% for comment in block.comments %}
                                            <div class="text-muted mb-1">
                                              <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                                              {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                                                <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                                              {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
                      {% endfor %}</code></pre>
                    {% endif %}
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                    <div class="logic-block-endcap border-top border-2 border-warning mt-2 pt-2">
                      <strong>END DO</strong>{% if block.label %} <span class="text-muted">{{ block.label }}</span>{% endif %}
                      {% if block.end_line %}<span class="badge bg-light text-dark ms-2">Line {{ block.end_line }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'select' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-success bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>SELECT CASE</strong> (<code>{{ block.condition }}</code>)
                    {% if block.label %}<span class="badge bg-secondary ms-2">{{ block.label }}</span>{% endif %}
                    {% if block.start_line and block.end_line %}
                      <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                    {% endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                    <div class="logic-block-endcap border-top border-2 border-success mt-2 pt-2">
                      <strong>END SELECT</strong>{% if block.label %} <span class="text-muted">{{ block.label }}</span>{% endif %}
                      {% if block.end_line %}<span class="badge bg-light text-dark ms-2">Line {{ block.end_line }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'case' %}
              <div class="card mb-2 {{ indent_class }}">
                <a data-bs-toggle="collapse" href="#{{ block_id }}" 
                   aria-expanded="false" 
                   class="text-decoration-none">
                  <div class="card-header bg-success bg-opacity-10">
                    <i class="fa fa-caret-right me-2"></i>
                    <strong>CASE</strong> (<code>{{ block.condition }}</code>)
                    {% if block.start_line and block.end_line %}
                      <span class="badge bg-light text-dark ms-2">Lines {{ block.start_line }}-{{ block.end_line }}</span>
                    {% endif %}
                  </div>
                </a>
                <div id="{{ block_id }}" class="collapse">
                  <div class="card-body">
                    {% if block.comments %}
                                          {% for comment in block.comments %}
                                            <div class="text-muted mb-1">
                                              <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                                              {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                                                <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                                              {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
                      {% endfor %}</code></pre>
                    {% endif %}
                    {% for child in block.children %}
                      {{ render_logic_block(child, loop.index, block_id ~ '-') }}
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% elif block.block_type == 'statements' %}
              {% if block.statements or block.comments %}
                <div class="card mb-2 {{ indent_class }}">
                  <div class="card-body">
                    {% if block.comments %}
                      {% for comment in block.comments %}
                        <div class="text-muted mb-1">
                          <i class="fa fa-comment me-1"></i><em>{{ comment }}</em>
                          {% if block.comment_lines and loop.index0 < block.comment_lines|length %}
                            <span class="text-muted small">(line {{ block.comment_lines[loop.index0] }})</span>
                          {% endif %}
                        </div>
                      {% endfor %}
                    {% endif %}
                    {% if block.statements %}
                      <pre class="mb-0"><code>{% for stmt in block.statements %}{{ render_statement_with_badges(stmt, block.statement_keywords[loop.index0] if block.statement_keywords and loop.index0 < block.statement_keywords|length else [], block.statement_lines[loop.index0] if block.statement_lines and loop.index0 < block.statement_lines|length else none) }}
                      {% endfor %}</code></pre>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            {% endif %}
          {% endmacro %}
          
          {% for block in procedure.logic_blocks %}
            {{ render_logic_block(block, loop.index) }}
          {% endfor %}
          {% else %}
            <em>n/a</em>
          {% endif %}
          
          {# Allocation Summary Section - Always shown, collapsible #}
          <div class="card mt-4 mb-2">
            <a data-bs-toggle="collapse" href="#allocations-summary-section" 
               aria-expanded="false" 
               aria-controls="allocations-summary-section" 
               class="text-decoration-none">
              <div class="card-header bg-secondary bg-opacity-10">
                <i class="fa fa-caret-down me-2"></i>
                <strong>Allocations</strong>
              </div>
            </a>
            <div id="allocations-summary-section" class="collapse">
              <div class="card-body">
                {% if procedure.allocation_summary %}
                <p class="text-muted mb-3">
                  Memory allocations and deallocations grouped by variable.
                </p>
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>Variable</th>
                      <th>Allocations</th>
                      <th>Deallocations</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for alloc in procedure.allocation_summary %}
                    <tr>
                      <td><code>{{ alloc.variable_name }}</code></td>
                      <td>
                        {% if alloc.allocate_lines %}
                          {% for line in alloc.allocate_lines %}
                            <span class="badge bg-success">line {{ line }}</span>{% if not loop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          <em>none</em>
                        {% endif %}
                      </td>
                      <td>
                        {% if alloc.deallocate_lines %}
                          {% for line in alloc.deallocate_lines %}
                            <span class="badge bg-warning text-dark">line {{ line }}</span>{% if not loop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          <em>none</em>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                  <em>n/a</em>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Section 6: Calls - show both list and graph #}
    <div class="card mb-3">
      <a data-bs-toggle="collapse" href="#calls-section" 
         aria-expanded="false" 
         aria-controls="calls-section" 
         class="text-decoration-none">
        <h3 class="card-header bg-light text-dark">
          <i class="fa fa-caret-down me-2"></i>Calls
        </h3>
      </a>
      <div id="calls-section" class="collapse">
        <div class="card-body">
          {% if procedure.callsgraph or procedure.calls %}
            {% if procedure.calls %}
            <h4>Procedures Called</h4>
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item">
                <ul class="list-inline">
                  {% for call in procedure.calls %}
                    <li class="list-inline-item">
                      {% if call is string %}
                        <code>{{ call }}</code>
                      {% elif call.get_url %}
                        {{ call | relurl(page_url) }}
                      {% else %}
                        <code>{{ call.name if call.name else call }}</code>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </li>
            </ul>
            {% endif %}
            
            {% if procedure.callsgraph %}
            <h4>Call Graph</h4>
            <p class="text-muted mb-3">
              Visual representation of procedures called by this {{ procedure.proctype }}.
            </p>
            <div class="depgraph">
              {{ procedure.callsgraph }}
            </div>
            {% endif %}
          {% else %}
            <em>n/a</em>
          {% endif %}
        </div>
      </div>
    </div>

    {% if procedure.binding %}
    <h3>Type Bound</h3>
    <p>{{ procedure.binding.parent | relurl(page_url) }}</p>
    {% endif %}

    {% if procedure.retvar %}
      <h3>Return Value
        <small>
          <span class="anchor" id="{{ procedure.retvar.anchor }}"></span>
          {{ procedure.retvar.full_declaration | relurl(page_url) }}
        </small>
      </h3>
      {{ procedure.retvar.doc }}
    {% endif %}

    {% if procedure.common %}
    <section>
      <h2>Common Blocks</h2>
      {% for com in procedure.common %}
      {{ macros.common_block(com) }}
      {% endfor %}
    </section>
    <br>
    <script>
      $(function () {
      $('[data-bs-toggle="popover"]').popover()
      })
    </script>
    {% endif %}

    {% if procedure.non_local_variables %}
    <section>    
      <h2>Variables</h2>
    {{ macros.variable_list(procedure.non_local_variables, permission=True) }}
    </section>
    <br>
    {% endif %}
    
    {% if procedure.enums %}
    <section>
    <h2>Enumerations</h2>
    {% for enum in procedure.enums %}
      {{ macros.enum_entry(enum) }}
    {% endfor %}
    </section>
    <br>
    {% endif %}
    
    {% if procedure.interfaces %}
  <section> 
     <h2>Interfaces</h2>
   {% for intr in procedure.interfaces %}
     {{ macros.interface(intr) }}
    {% endfor %}
    </section>
   <br>
    {% endif %}

    {% if procedure.absinterfaces %}
    <section>
   <h2>Abstract Interfaces</h2>
   {% for intr in procedure.absinterfaces %}
     {{ macros.absinterface(intr) }}
    {% endfor %}
    </section>
   <br>
    {% endif %}
    
    {% if procedure.types %}
    <section>
   <h2>Derived Types</h2>
   {% for type in procedure.types %}
     {{ macros.type_summary(type) }}
    {% endfor %}
    </section>
   <br>
    {% endif %}
    
    {% if procedure.functions %} 
    <section>
    <h2>Functions</h2>
    {% for proc in procedure.functions %}
    {{ macros.proc_entry(proc) }}
    {% endfor %}
    </section>
    <br>
    {% endif %}


    {% if procedure.subroutines %}
    <section>
    <h2>Subroutines</h2>
    {% for proc in procedure.subroutines %}
    {{ macros.proc_entry(proc) }}
    {% endfor %}
    </section>    
    {% endif %}

    {% if procedure.namelists %}
      <section>
        <h2>Namelists</h2>
        {% for namelist in procedure.namelists %}
          {{ macros.namelist_panel(namelist) }}
        {% endfor %}
      </section>
    {% endif %}
    
    {% if procedure.src %}
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    {{ procedure.src }}
    </section>
    <br>
    {% endif %}
    
    </div>
  </div>

{% endblock body %}
